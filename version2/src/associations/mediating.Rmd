---
title: "Mediating"
author: "Julian Frattini"
date: "2025-07-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lme4)
library(ggdag)

# utility methods for extracting coefficient distributions from two models
source("../util/extract-coefficients.R")
```

This notebook visualizes the effect of a mediator (also called *pipe*) in causal inference.

```{r configuration}
varname.a <- "Technique" # independent variable (binary)
varname.b <- "Tool Appeal" # dependent variable (continuous)
varname.c <- "Productivity" # mediator (continuous)

effect.ab <- 0.5
effect.ac <- -1
effect.cb <- 2
```

## Simulation

Firstly, we can visualize a directed acyclic graph (DAG) representing the simulated causal relationships.
The mediator is caused by the cause and also affects the outcome.

```{r dag}
dag <- dagify(
  b ~ a + c , # causal effect of the independent on the dependent variable (both direct and indirect)
  c ~ a, # effect of the independent variable on the mediator
  exposure = "a", outcome = "b",
  
  labels = c(a = varname.a, b = varname.b, c = varname.c),
  coords = list(x = c(a = 0, b = 2, c = 1), 
                y = c(a = 1, b = 1, c = 0))
)

ggdag_status(dag, use_labels = "label", text = FALSE) +
  guides(fill = "none", color = "none") + 
  theme_dag()
```

Based on these causal assumptions, we can simulate a data set with $n$ observations.
The causal relationships impact the distributions of the variables.

```{r simulation}
n <- 1000

d <- data.frame(a = rbinom(n, 1, 0.5)) %>% 
  mutate(
    c = rnorm(n, effect.ac*a, 1),
    b = rnorm(n, effect.ab*a + effect.cb*c, 1)
  )
```

## Data Analysis

Based on these simulations, we can train two regression models: one estimating the total effect (`m1`) and one estimating the direct and indirect effect (`m2`).

```{r model-total}
m1 <- lm(formula = (b ~ a), data = d)
summary(m1)
```

```{r model-direct}
m2 <- lm(formula = b ~ a + c, data = d)
summary(m2)
```

Additionally, we can also esimate the effect of the cause on the mediator.

```{r model-mediator}
m3 <- lm(formula = c ~ a, data = d)
```

## Visualizations

The comparison of `m1` and `m2` show that both models determine the "correct" effect, but `m1` only identifies the total effect while `m2` can differentiate the direct from the indirect effect.

```{r visualize-coefficients}
get.coefficient.distributions(m1, m2, "Model m1 (total)", "Model m2 (differentiated)") %>% 
  ggplot(aes(y = factor)) +
    geom_point(aes(x = estimate)) + 
    geom_errorbar(aes(xmin = lower, xmax = upper)) +
    geom_vline(xintercept = effect.ab + effect.ac*effect.cb, 
               linetype = "dashed", color = "cyan", linewidth = 0.9) + 
    geom_vline(xintercept = effect.ab, 
               linetype = "dashed", color = "grey", linewidth = 0.9) + 
    geom_vline(xintercept = effect.cb, 
               linetype = "dashed", color = "grey", linewidth = 0.9) + 
    facet_wrap(vars(model), ncol=1) +
  labs(x = "Estimated effect", y = "Factors") +
  scale_y_discrete(labels = c(varname.a, varname.c)) +
  theme_bw()

ggsave(filename = "figures/mediating-effects.pdf", 
       device = "pdf", width = 4, height = 2)
```

```{r visualize-mediator}
get.coefficient.distributions(m2, m3, "Model m2 (differentiated)", "Model m3 (mediator)") %>% 
  ggplot(aes(y = factor)) +
    geom_point(aes(x = estimate)) + 
    geom_errorbar(aes(xmin = lower, xmax = upper)) +
    geom_vline(xintercept = effect.ac, 
               linetype = "dashed", color = "grey", linewidth = 0.9) + 
    geom_vline(xintercept = effect.ab, 
               linetype = "dashed", color = "grey", linewidth = 0.9) + 
    geom_vline(xintercept = effect.cb, 
               linetype = "dashed", color = "grey", linewidth = 0.9) + 
    facet_wrap(vars(model), ncol=1) +
  labs(x = "Estimated effect", y = "Factors") +
  scale_y_discrete(labels = c(varname.a, varname.c)) +
  theme_bw()

ggsave(filename = "figures/mediating-effects-mediator.pdf", 
       device = "pdf", width = 4, height = 2)
```

