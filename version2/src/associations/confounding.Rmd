---
title: "Confounding"
author: "Julian Frattini"
date: "2025-07-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lme4)
library(ggdag)

# utility methods for extracting coefficient distributions from two models
source("../util/extract-coefficients.R")
```

This notebook visualizes the effect of common causes (also called *forks* and *confounders*) in causal inference.
Forks are one of the most common sources for spurious associations in causal inference and, hence, particularly dangerous to the validity of drawn conclusions.

```{r configuration}
varname.a <- "Specification Format" # independent variable (binary)
varname.b <- "Lead Time" # dependent variable (continuous)
varname.c <- "Pressure" # confounder (binary)

effect.ab <- 0 # effect of interest (A -> B)
effect.ca <- 0.5 # confounding effect of C on A
effect.cb <- -2 # confounding effect of C on B
```

```{r dag}
dag <- dagify(
  b ~ a + c,
  a ~ c,
  exposure = "a", outcome = "b",
  
  labels = c(a = varname.a, b = varname.b, c = varname.c),
  coords = list(x = c(a = 0, b = 2, c = 1), 
                y = c(a = 0, b = 0, c = 1))
)

ggdag_status(dag, use_labels = "label", text = FALSE) +
  guides(fill = "none", color = "none") + 
  theme_dag()
```

```{r simulation}
n <- 1000 # number of simulated units, i.e., implemented features

d <- data.frame(c = rbernoulli(n, 0.3)) %>% 
  mutate(
    a = rbernoulli(n, 0.8-0.5*effect.ca),
    b = rnorm(n, effect.ab*a + effect.cb*c, 1))
```

```{r model-biased}
m1 <- lm(formula = (b ~ a), data = d)
summary(m1)
```

```{r model-controlled}
m2 <- lm(formula = (b ~ a + c), data = d)
summary(m2)
```

```{r}
get.coefficient.distributions(m1, m2, "Model m1 (biased)", "Model m2 (unbiased)") %>% 
  ggplot(aes(y = factor)) +
    geom_point(aes(x = estimate)) +
    geom_errorbar(aes(xmin = lower, xmax = upper)) +
    geom_vline(xintercept = effect.ab,
               linetype = "dashed", color = "cyan", size = 0.9) +
    geom_vline(xintercept = effect.cb,
               linetype = "dashed", color = "grey", size = 0.9) +
    facet_wrap(vars(model), ncol=1) +
  labs(x = paste("Estimated effect on", varname.b), y = "Factors") +
  scale_y_discrete(labels = c(varname.c, varname.a)) +
  theme_bw()
```


